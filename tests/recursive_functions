#!/usr/bin/env bash

file=$(mktemp)
loadc_op=$(echo -e '\x01')
add_op=$(echo -e '\x02')
sub_op=$(echo -e '\x03')
mkbasic_op=$(echo -e '\x06')
getbasic_op=$(echo -e '\x07')
leq_op=$(echo -e '\x08')
jump_op=$(echo -e '\x0B')
jumpz_op=$(echo -e '\x0C')
pushloc_op=$(echo -e '\x0D')
mkvec_op=$(echo -e '\x0E')
pushglob_op=$(echo -e '\x0F')
slide_op=$(echo -e '\x13')
mkfunval_op=$(echo -e '\x14')
targ_op=$(echo -e '\x15')
return_op=$(echo -e '\x16')
mark_op=$(echo -e '\x17')
apply_op=$(echo -e '\x18')
alloc_op=$(echo -e '\x19')
rewrite_op=$(echo -e '\x1A')

# let rec f = fun a -> if a <= 3 then f (a + 1) else 60
# let rec g = fun a -> if 2 <= a then g (a - 1) else f a
# in g 3

echo -e \
"$alloc_op"\
"\x02\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$pushloc_op"\
"\x01\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$mkvec_op"\
"\x01\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$mkfunval_op"\
"\x2D\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$jump_op"\
"\xC6\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$targ_op"\
"\x01\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$pushloc_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$getbasic_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$loadc_op"\
"\x03\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$leq_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$jumpz_op"\
"\xAB\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$mark_op"\
"\xBD\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$pushloc_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$getbasic_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$loadc_op"\
"\x01\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$add_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$mkbasic_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$pushglob_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$apply_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$loadc_op"\
"\x3C\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$mkbasic_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$return_op"\
"\x01\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$rewrite_op"\
"\x02\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$pushloc_op"\
"\x01\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$pushloc_op"\
"\x02\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$mkvec_op"\
"\x02\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$mkfunval_op"\
"\xFC\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$jump_op"\
"\xA7\x01\x00\x00"\
"\x00\x00\x00\x00"\
"$targ_op"\
"\x01\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$loadc_op"\
"\x02\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$pushloc_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$getbasic_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$leq_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$jumpz_op"\
"\x7A\x01\x00\x00"\
"\x00\x00\x00\x00"\
"$mark_op"\
"\x9E\x01\x00\x00"\
"\x00\x00\x00\x00"\
"$loadc_op"\
"\x01\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$pushloc_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$getbasic_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$sub_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$mkbasic_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$pushglob_op"\
"\x01\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$apply_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$mark_op"\
"\x9E\x01\x00\x00"\
"\x00\x00\x00\x00"\
"$pushloc_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$pushglob_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$apply_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$return_op"\
"\x01\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$rewrite_op"\
"\x01\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$mark_op"\
"\xDD\x01\x00\x00"\
"\x00\x00\x00\x00"\
"$loadc_op"\
"\x03\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$mkbasic_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$pushloc_op"\
"\x02\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$apply_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$slide_op"\
"\x02\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$getbasic_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"\x00" > "$file"

./build/fm "$file"
result="$?"

if [[ "$result" -ne 60 ]]; then
  echo "tests/recursive_functions failure: expected $result to equal 60"
  exit 1
fi
