#!/usr/bin/env bash

file=$(mktemp)
loadc_op=$(echo -e '\x01')
pushloc_op=$(echo -e '\x0D')
mkstringd_op=$(echo -e '\x22')
fopen_op=$(echo -e '\x23')
fputs_op=$(echo -e '\x24')
fgets_op=$(echo -e '\x25')
appends_op=$(echo -e '\x26')

# let stdin = fopen "/dev/stdin" "r"
# and stdout = fopen "/dev/stdout" "w"
# an input = fgets 5 stdin
# in fputs "input: #{input}" stdout
# => 0

echo -e \
"$mkstringd_op"\
"\x90\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$mkstringd_op"\
"\x99\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$fopen_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$mkstringd_op"\
"\xAB\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$mkstringd_op"\
"\xB4\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$fopen_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$pushloc_op"\
"\x01\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$loadc_op"\
"\x05\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$fgets_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$pushloc_op"\
"\x02\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$pushloc_op"\
"\x03\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$mkstringd_op"\
"\xC7\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$appends_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$fputs_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$loadc_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"\x00"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"\x01\x00\x00\x00"\
"\x00\x00\x00\x00"\
"\x72"\
"\x0A\x00\x00\x00"\
"\x00\x00\x00\x00"\
"\x2f\x64\x65\x76\x2f\x73\x74\x64\x69\x6e"\
"\x01\x00\x00\x00"\
"\x00\x00\x00\x00"\
"\x77"\
"\x0B\x00\x00\x00"\
"\x00\x00\x00\x00"\
"\x2f\x64\x65\x76\x2f\x73\x74\x64\x6f\x75\x74"\
"\x08\x00\x00\x00"\
"\x00\x00\x00\x00"\
"\x69\x6e\x70\x75\x74\x3a\x20\x00"\
 > "$file"

result=$(echo "HORSEY TIME" | ./build/fm "$file")

if [[ "$result" != "input: HORSE" ]]; then
  echo "tests/write failure: expected '$result' to equal 'input: HORSE'"
  exit 1
fi
