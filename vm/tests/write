#!/usr/bin/env bash

file=$(mktemp)
loadc_op=$(echo -e '\x01')
pushloc_op=$(echo -e '\x0D')
mkstringd_op=$(echo -e '\x22')
fopen_op=$(echo -e '\x23')
fputs_op=$(echo -e '\x24')

# let handler = fopen "/dev/stdout" "w"
# in fputs "HORSE" handler
# => 0

echo -e \
"$mkstringd_op"\
"\x5B\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$mkstringd_op"\
"\x48\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$fopen_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$pushloc_op"\
"\x01\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$mkstringd_op"\
"\x64\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$fputs_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"$loadc_op"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"\x00"\
"\x00\x00\x00\x00"\
"\x00\x00\x00\x00"\
"\x0B\x00\x00\x00"\
"\x00\x00\x00\x00"\
"\x2f\x64\x65\x76\x2f\x73\x74\x64\x6f\x75\x74"\
"\x01\x00\x00\x00"\
"\x00\x00\x00\x00"\
"\x77"\
"\x05\x00\x00\x00"\
"\x00\x00\x00\x00"\
"\x48\x4f\x52\x53\x45"\
 > "$file"

result=$(./build/fm "$file")

if [[ "$result" != "HORSE" ]]; then
  echo "tests/write failure: expected '$result' to equal 'HORSE'\n"
  exit 1
fi
